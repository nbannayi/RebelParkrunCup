@page "/add-runners"
@inject HttpClient Http
@using RebelParkrunCup.Shared

<h3>ADD RUNNERS</h3>
<p>Use this screen to add runners to the system, these will then immediately be reflected in the VIEW RUNNERS screen.</p>

<EditForm Model="@newRunner" OnValidSubmit="HandleSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <p><div>
        <label for="firstName">First Name:</label>
        <InputText id="firstName" @bind-Value="newRunner.FirstName" />
    </div>
    </p>
    <p>
    <div>
        <label for="lastName">Last Name:</label>
        <InputText id="lastName" @bind-Value="newRunner.LastName" />
    </div>
    </p>
    <p>
    <div>
        <label for="baselineTime">Baseline Time (mm:ss):</label>
        <InputText id="baselineTime" @bind-Value="BaselineTimeString" />
    </div>
    </p>
    <button type="submit">Submit</button>
</EditForm>

@if (!string.IsNullOrEmpty(resultMessage))
{
    <p>@resultMessage</p>
}

@code {
    private Runner newRunner = new Runner();
    private string BaselineTimeString = "";  // Stores "mm:ss" input as a string
    private string resultMessage = "";
    private async Task HandleSubmit()
    {
        if (!string.IsNullOrWhiteSpace(BaselineTimeString))
        {
            var parts = BaselineTimeString.Split(':');
            if (parts.Length == 2 && int.TryParse(parts[0], out int mins) && int.TryParse(parts[1], out int secs))
            {
                newRunner.BaselineTimeMins = mins;
                newRunner.BaselineTimeSecs = secs;

                // Send the new runner to the API
                var response = await Http.PostAsJsonAsync("api/runners", newRunner);
                
                if (response.IsSuccessStatusCode)
                {
                    resultMessage = "Runner successfully added!";
                    newRunner = new Runner();  // Reset form
                    BaselineTimeString = "";  // Reset time field
                }
                else
                {
                    resultMessage = "Failed to save runner.";
                }
            }
            else
            {
                resultMessage = "Invalid time format. Please enter in mm:ss format.";
            }
        }
    }
}